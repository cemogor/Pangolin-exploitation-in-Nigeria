# LOAD PACKAGES -----------------------------------------------------------
rm(list=ls())
library(tidyverse)
library(dplyr)
library(tidyr)
library(zoo)
library(lubridate)
library(ggplot2)
library(ggsci)
library(wesanderson)
library(ggpubr)
library(stringr)
library(purrr)
library(janitor)
library(networkD3)
library(data.table)
library(ggsankey)
library(litteR)
library(blueycolors)



################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
###############                                                #################
###############               MEAT PALATABILITY                #################
###############                                                #################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#DATA: The dataset contains scores assigned to >90 different meats by 570 hunters and vendors based on their 
       #perceived palatability of the meat. Scores range from 1-10 with 10 being most palatable. 

palatability <- read.csv("01.palatability.clean.csv")

names(palatability)

#METADATA: name.interviewer: Name of interviewer
          #village: Name of community
          #type.respondent: whether respondent is a hunter of vendor
          #sex: sex of respondent (man or woman)
          #animal: the meat type
          #score: palatability score assigned to each meat by the respondents (ranged from 1-10)
          #X_id: unique ID for each respondent 
          #Category: wild, domestic, fish, or invertebrate
          


# COUNT CALCULATIONS ------------------------------------------------------
#Count the number of people that scored each meat type.

palatability$number <- rep(1, nrow(palatability)) #create new column with 1s

#Calculate count per species 
count <- palatability %>% 
  group_by(animal, category) %>% 
  summarise(count = sum(number)) %>% 
  ungroup() %>% 
  mutate(animal.color = ifelse(animal %in% c("Giant pangolin", "Black-bellied pangolin", "White-bellied pangolin"), "Pangolin", "Other"))


################################################################################
################################################################################
###############                                                #################
###############          FIGURE 4: MEAN PALATABILITY           #################
###############                                                #################
################################################################################
################################################################################


# Mean --------------------------------------------------------------------

mean.palatability <- palatability %>% 
  group_by(animal, category) %>% 
  summarise(mean = mean(score),
            stdv = sd(score))


# All ---------------------------------------------------------------------

ggplot(mean.palatability, aes(animal, mean)) +
  geom_col() +
  facet_wrap(~category,scales = "free_y") +
  coord_flip() +
  geom_errorbar(aes(ymin=mean-stdv, ymax=mean+stdv), width=.2,
                position=position_dodge(.9))

# Domestic meat -----------------------------------------------------------

dm.mean <- ggplot(mean.palatability %>% filter(category == "Domestic meat"),   aes(x = reorder(animal, mean), y = mean)) +
  geom_col(fill='#45842e') +
  geom_text(data=count%>% filter(category == "Domestic meat"), aes(x=animal, y=11.5, label=count), size=3.4)+
  geom_errorbar(aes(ymin=mean-stdv, ymax=mean+stdv), width=.2,
                position=position_dodge(.9)) +
  theme_pubr(base_size = 12) +
  theme(
    axis.title = element_text(size = 20),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank()) +
  labs(y="", x= "Domestic meat", face="bold") +
  coord_flip() +
  scale_y_continuous(breaks =seq(1,10,1))

dm.mean

# Fish  -------------------------------------------------------------------


fish.mean <- ggplot(mean.palatability %>% filter(category == "Fish"),   aes(x = reorder(animal, mean), y = mean)) +
  geom_col(fill='#45842e') +
  geom_text(data=count%>% filter(category == "Fish"), aes(x=animal, y=11.5, label=count), size=3.4)+
  geom_errorbar(aes(ymin=mean-stdv, ymax=mean+stdv), width=.2,
                position=position_dodge(.9)) +
  theme_pubr(base_size = 12) +
  theme(
    axis.title = element_text(size = 20),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank()) +
  labs(y="", x= "Fish", face="bold") +
  coord_flip() +
  scale_y_continuous(breaks =seq(1,10,1))

fish.mean

# Invertebrates -----------------------------------------------------------

invert.mean <- ggplot(mean.palatability %>% filter(category == "Invertebrate"),   aes(x = reorder(animal, mean), y = mean)) +
  geom_col(fill='#45842e') +
  geom_text(data=count%>% filter(category == "Invertebrate"), aes(x=animal, y=11.5, label=count), size=3.4)+
  geom_errorbar(aes(ymin=mean-stdv, ymax=mean+stdv), width=.3,
                position=position_dodge(.9)) +
  theme_pubr(base_size = 12) +
  theme(
    axis.title = element_text(size = 20),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank()) +
  labs(y="", x= "Invertebrate", face="bold") +
  coord_flip() +
  scale_y_continuous(breaks =seq(1,10,1))

invert.mean

# Wild meat ---------------------------------------------------------------

# Define colors for pangolins and other meat types
mean.palatability <- mean.palatability %>%
  mutate(animal.color = ifelse(animal %in% c("Giant pangolin", "Black-bellied pangolin", "White-bellied pangolin"), "Pangolin", "Other")) %>% 
  mutate(animal.color = factor(animal.color, levels = c("Pangolin", "Other")))

#Specify colors
animal.colors <- c("Pangolin" = "#804674", "Other" = "#45842e") 


wild.mean <- ggplot(mean.palatability %>% filter(category == "Wild meat"),  aes(x = reorder(animal, mean), y = mean, fill = animal.color)) +
  geom_col(width = 0.85) +
  geom_text(data=count%>% filter(category == "Wild meat"), aes(x=animal, y=11.5, label=count), size=3.6)+
  geom_errorbar(aes(ymin=mean-stdv, ymax=mean+stdv), width=.3,
                position=position_dodge(.9)) +
  theme_pubr(base_size = 12) +
  theme(
    legend.text = element_text(size = 15),
    axis.title = element_text(size = 20),
    panel.grid.minor = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none") +
  labs(y="", x= "Wild meat", face="bold", fill = "") +
  coord_flip() +
  scale_y_continuous(breaks =seq(1,10,1)) +
  scale_fill_manual(values = animal.colors)

wild.mean

# SAVE PLOT ---------------------------------------------------------------

three.mean <- ggarrange(dm.mean, fish.mean, invert.mean, 
                        nrow = 3,
                        labels = "AUTO",
                        align = "v",
                        heights = c(1,.8,1),
                        font.label = list(size = 25))


all.mean <- ggarrange(three.mean, wild.mean,
                      labels = c(" ", "D"),
                      widths = c(1.1,1.4),
                      font.label = list(size = 25))

all.mean <- annotate_figure(all.mean, bottom = text_grob("Palatability", color = "black", rot = 0, size = 20))


all.mean

ggsave("fig4.tiff",
       plot = all.mean,
       path = "Figure",
       width = 28,
       height = 37,
       units = c("cm"),
       dpi = 600)


################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
###############                                                #################
###############              COMMUNITY DYNAMICS                #################
###############                                                #################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#DATA: this dataset contains household-level information from the communities selected for the study. 

comm.clean <- read.csv("02.comm.clean.csv")

names(comm.clean)

#NOTE: interviewer = person conducting the interviews
       #state = administrative district in Nigeria 
       #location = community name 
       #household.id = unique ID for each household
       #number.people = the number of people in the household
       #gun.hunter.count = number of people who identify as un hunters 
       #trapper.count = number of people who identify as trappers 
       #trader.count = number of people who trade wild meat
       #unique ID per interview
      

# VISUALISE DATA - AND SUMMARY STATS --------------------------------------


ggplot(comm.clean, aes(number.people)) +
  geom_density()


ggplot(comm.clean, aes(gun.hunter.count)) +
  geom_density()

ggplot(comm.clean, aes(trader.count)) +
  geom_density()


median(comm.clean$number.people)
median(comm.clean$gun.hunter.count)
median(comm.clean$trader.count)


################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
###############                                                #################
###############            INFLATION ACCOUNTING                #################
###############                                                #################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################


cpi <- read.csv("03.cpi.csv")

cpi <- cpi %>% 
  mutate(period = case_when(year >= 2010 & year <= 2015 ~ "2010",
                            year >= 2016 & year <= 2019 ~ "2016",
                            year == 2020 ~ "lockdown",
                            year >= 2021 & year <= 2023 ~ "postlockdown")) %>% 
  group_by(period) %>% 
  summarise(cpi.period = median(cpi)) %>% 
  drop_na() %>% 
  mutate(rate = cpi.period [period == "postlockdown"]/cpi.period) #Value in subsequent years * (CPI in  subsequent year/CPI in base year)


################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
###############                                                #################
###############                PANGOLIN DYNAMICS               #################
###############                                                #################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#NOTE: Data on motivations, uses, and prices of pangolin meat and scales gathered 
#from hunters and vendors. 

# LOAD DATA ---------------------------------------------------------------

rawdata.clean <- read.csv("04.rawdata.clean.csv")

#NOTE: Variables can be gleaned from column names. 

names(rawdata.clean)

# CREATE METADATA ---------------------------------------------------------

metadata.clean <- rawdata.clean %>% 
  subset(select = c(interviewer:dob, id))


################################################################################
################################################################################
###############                                                #################
###############   PROCESS COMPONENTS OF THE DATA INDIVIDUALLY  #################
###############                                                #################
################################################################################
################################################################################


# NUMBER OF ANIMALS HUNTED ------------------------------------------------

number <- rawdata.clean %>% 
  subset(select = c(bbp.dry:duiker.wet, id)) %>% 
  pivot_longer(bbp.dry:duiker.wet, names_to = "text", values_to = "number.caught") %>%
  separate(text, into = c("species", "season"), sep = "\\.") %>% 
  left_join(metadata.clean, by = "id") %>% 
  drop_na() #Drop rows belonging to market vendors that contains NAs in the number.caught column

names(rawdata.clean)

zero.catch <- number %>% 
  filter(species == c("wbp", "bbp")) %>% 
  filter(number.caught == 0) %>% 
  dplyr::select(respondent.id)

length(unique(number$id)) #Matches the total number of hunters

# USES OF PANGOLIN MEAT AND SCALES ----------------------------------------

uses <- rawdata.clean %>% 
  subset(select = c(eat.all.meat.2010:access.market.scale.postlockdown, id)) %>% 
  pivot_longer(eat.all.meat.2010:access.market.scale.postlockdown, names_to = "text", values_to = "prop.use") %>%
  separate(text, into = c("uses", "type", "part", "period"), sep = "\\.") %>% 
  left_join(metadata.clean, by = "id") %>% 
  drop_na() %>% #Drop respondents that did not provide any response for this question. 
  filter(!(respondent.id %in% zero.catch$respondent.id)) #Remove people who did not catch any pangolin as this question relates to uses of the animal. 

length(unique(uses$id)) 

# REASONS FOR HUNTING -----------------------------------------------------

reason <- rawdata.clean %>% 
  subset(select = c(foodmeat.reason.2010:medicinescale.reason.postlockdown, id)) %>% 
  pivot_longer(foodmeat.reason.2010:medicinescale.reason.postlockdown, names_to = "text", values_to = "prop.reason") %>%
  separate(text, into = c("reason", "variable", "period"), sep = "\\.") %>% 
  left_join(metadata.clean, by = "id") %>% 
  drop_na() #Drop respondents that did not provide any response for this question. 

length(unique(reason$id)) #Matches the number of hunters.


# MOTIVE FOR HUNTING ------------------------------------------------------

motive <- rawdata.clean %>% 
  subset(select = c(opportunistic.motive.2010:paid.motive.postlockdown, id)) %>% 
  pivot_longer(opportunistic.motive.2010:paid.motive.postlockdown, names_to = "text", values_to = "prop.motive") %>%
  separate(text, into = c("motive", "variable", "period"), sep = "\\.") %>% 
  left_join(metadata.clean, by = "id") %>% 
  drop_na() ##Drop respondents that did not provide any response for this question. 

length(unique(motive$id)) #Matches the number of hunters. 

# METHOD FOR HUNTING ------------------------------------------------------

method <- rawdata.clean %>% 
  subset(select = c(gun.2010:dog.postlockdown, id)) %>% 
  pivot_longer(gun.2010:dog.postlockdown, names_to = "text", values_to = "prop.method") %>%
  separate(text, into = c("method", "period"), sep = "\\.") %>% 
  left_join(metadata.clean, by = "id") %>% 
  drop_na() %>% ##Drop respondents that did not provide any response for this question. 
  filter(!(respondent.id %in% zero.catch$respondent.id & period %in% c("lockdown", "postlockdown")))

length(unique(method$id)) #Matches the number of hunters. 


# PRICE -------------------------------------------------------------------

price <- rawdata.clean %>% 
  subset(select = c(price.meat.porcupine.2010:price.scale.wbp.postlockdown, id)) %>% 
  pivot_longer(price.meat.porcupine.2010:price.scale.wbp.postlockdown, names_to = "text", values_to = "price") %>%
  separate(text, into = c("variable", "part", "species", "period"), sep = "\\.") %>% 
  left_join(metadata.clean, by = "id") %>%
  drop_na() %>% ##Drop respondents that did not provide any response for this question. 
  mutate(unique.id = row_number())
  

length(unique(price$id)) #Matches the number of respondents. 


# CLEAN PRICE DATA BASED ON RESPORTS FROM THE FIELD -----------------------

price <- price %>% 
  #Merge inflation data
  left_join(cpi, by = "period") %>% 
  
  #Delete prices less than 10 because its erroneous. 
  filter(price >= 10) %>% 
  
  #999 was the code to input (to proceed to the next page) when a respondent 
  #did not provide a price for a species/period, so deleting all rows with 999. 
  filter(price != 999) %>%
  
  #The team made some errors in typing 999, 
  #so I'm deleting 99, 9999, and 699, which are likely errors while inputting 999. 
  filter(!grepl("99", price)) %>%  
  
  #Frederick (FRED) collected data wrongly until this period. 
  #He was collecting price per kg instead of per animal. This was latter rectified. 
  filter(!(interviewer == "Frederick (FRED)" & part == "scale" & (location == "Ikom (IKOM)" | location == "Watt (WAT)"))) %>% 
  
  #Dominic a mistake with an additional zero.
  mutate(price = if_else(part == "scale" & respondent.id == "DOMBATE03" & period == 2016 & price == 15000, 1500, price)) %>%  
  
  #Ditto
  mutate(price = if_else(part == "scale" & respondent.id == "DOMBATE03" & period == "lockdown" & price == 15000, 1500, price)) %>%  
  
  #Ben made a mistake here by writing one additional zero. 
  mutate(price = if_else(species == "hog" & respondent.id == "BENIKO23" & period == 2010 & price == 450000, 45000, price)) %>% 
  
  #Ditto
  mutate(price = if_else(species == "bbp" & respondent.id == "STANIKO6" & period == "postlockdown" & price == 50000, 5000, price)) %>% 
  
  #Ditto
  mutate(price = if_else(species == "wbp" & respondent.id == "BENIKOM05" & period == 2016 & price == 45000, 4500, price)) %>% 
  
  #Ditto
  mutate(price = if_else(species == "bbp" & respondent.id == "DOMIKO08" & period == "postlockdown" & price == 45000, 4500, price)) %>% 
  mutate(price = case_when(unique.id == 6876 ~ 4000,
                           unique.id == 3709 ~ 3250,
                           unique.id == 4832 ~ 3000,
                           unique.id == 20459 ~ 2500, TRUE ~ price)) %>% 
  
  #Apply inflation: value in subsequent years * (CPI in  subsequent year/CPI in base year)
  mutate(price.adjusted = round(price * 421.0711/cpi.period)) %>%  
  mutate(price.adjusted2 = round(price * rate)) %>% 
  mutate(price.adjusted3 = round(price * 421.0711)/cpi.period) %>% 
  arrange(interviewer) %>% 
  
  #Order levels and rename variables 
  # Order levels and rename variables
  mutate(period = factor(period, levels = c("2010", "2016", "lockdown", "postlockdown"))) %>%
  mutate(period = dplyr::recode(period,
                         `2010` = "Jan 2010-Dec 2015",
                         `2016` = "Jan 2016-Feb 2020",
                         `lockdown` = "April-Sept 2020 (COVID lockdown)",
                         `postlockdown` = "Oct 2020-Sept 2023")) %>%
  mutate(species = dplyr::recode(species,
                          "hog" = "Red river hog",
                          "bbp" = "Black-bellied pangolin",
                          "duiker" = "Blue duiker",
                          "porcupine" = "Porcupine",
                          "wbp" = "White-bellied pangolin")) %>%
  mutate(part = dplyr::recode(part,
                       "meat" = "Meat",
                       "scale" = "Scale"))

length(unique(price$id)) #The number of respondents and total number of rows have dropped (from 809 to 804 for number of respondents) because of deleting missing values (lines 1358-1361).


# CHECK MERGER ------------------------------------------------------------
anti_join(price, metadata.clean, by = "household.id")
anti_join(metadata.clean, price, by = "household.id")

length(unique(price$household.id)) #Check the number of unique household ID in the price data.
length(unique(metadata.clean$household.id)) ##Check the number of unique household ID in the metadata data.


################################################################################
################################################################################
###############                                                #################
###############               GET AVERAGES                     #################
###############                                                #################
################################################################################
################################################################################


# Meat vs scales (pangolins) ----------------------------------------------

price.pang <- price %>% 
  filter(species %in% c("Black-bellied pangolin", "White-bellied pangolin")) %>% 
  group_by(id, species, part) %>% 
  mutate(count = n()) %>% 
  filter(count == 4)


length(unique(price.pang$id))


# Price (all) -------------------------------------------------------------

price.all <- price %>% 
  filter(species %in% c("Porcupine", "Red river hog", "Blue duiker")) %>% 
  mutate(item = paste0(species, "_", part)) %>% 
  group_by(id, species) %>% 
  mutate(count = n()) %>% 
  filter(count == 4)

length(unique(price.all$id))
  

# Check consistency in responses across respondents ----------------------

#IDs that are in both data frames (pangolin and other species)

id.intersection <- intersect(unique(price.all$id), unique(price.pang$id))

length(id.intersection)

#IDs that are found in either data frames.
id.union <- price.all %>% 
  bind_rows(price.pang) %>% 
  group_by(id, respondent.type) %>% 
  summarise (sum = n())

sum(id.union$sum)

# Count unique ids by respondent.type
respondent.counts <- id.union %>%
  group_by(respondent.type) %>%
  summarise(count = n_distinct(id), .groups = 'drop')

nrow(id.union)


# Transformation of responses to proportions ------------------------------

uses <- uses %>% 
  mutate(proportion = prop.use/10) %>% 
  mutate(period = factor(period, levels = c("2010", "2016", "lockdown", "postlockdown"))) %>% 
  mutate(period = dplyr::recode(period, "2010" = "Jan 2010-Dec 2015","2016" = "Jan 2016-Feb 2020",
                         "lockdown" = "April-Sept 2020 (COVID lockdown)", "postlockdown" = "Oct 2020-Sept 2023")) %>% 
  mutate(uses = dplyr::recode(uses, "eat" = "Eat", "medicine" = "Medicine", "sell" = "Sell", "discard" = "Discard", "medicine" = "Medicine", "sell" = "Sell", "access" = "No access to scales"))


reason <- reason %>% 
  mutate(proportion = prop.reason/10) %>% 
  mutate(period = dplyr::recode(period, "2010" = "Jan 2010-Dec 2015","2016" = "Jan 2016-Feb 2020",
                         "lockdown" = "April-Sept 2020 (COVID lockdown)", "postlockdown" = "Oct 2020-Sept 2023")) %>% 
  mutate(reason = dplyr::recode(reason, "foodmeat" = "Meat (home use)", "medicinescale" = "Scale (home use)",  "sellmeat" = "Meat (sale)", "sellscale" = "Scale (sale)")) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  mutate(reason = factor(reason, levels = c( "Scale (sale)", "Scale (home use)","Meat (sale)", "Meat (home use)")))
  

motive <- motive %>% 
  mutate(proportion = prop.motive/10) %>% 
  mutate(period = dplyr::recode(period, "2010" = "Jan 2010-Dec 2015","2016" = "Jan 2016-Feb 2020",
                         "lockdown" = "April-Sept 2020 (COVID lockdown)", "postlockdown" = "Oct 2020-Sept 2023")) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  mutate(motive = dplyr::recode(motive, "opportunistic" = "Opportunistic", "paid" = "Paid pangolin hunt",  "pangolinhunting" = "Non-paid pangolin hunt", "wildmeat" = "Wild meat hunt")) %>% 
  mutate(motive = factor(motive, levels = c("Paid pangolin hunt", "Non-paid pangolin hunt", "Wild meat hunt", "Opportunistic")))


method <- method %>% 
  mutate(proportion = prop.method/10) %>% 
  mutate(period = dplyr::recode(period, "2010" = "Jan 2010-Dec 2015","2016" = "Jan 2016-Feb 2020",
                         "lockdown" = "April-Sept 2020 (COVID lockdown)", "postlockdown" = "Oct 2020-Sept 2023")) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  mutate(method = dplyr::recode(method, "gun" = "Gun", "dog" = "Dog",  "pickup" = "Hand", "trap" = "Trap"))


table(method$method)


# Uses of pangolin meat ---------------------------------------------------

uses.meat <- uses %>% 
  filter(part == "meat") %>% 
  group_by(uses, period, hunter.type, respondent.type) %>% 
  summarise(avg = mean(proportion)) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  filter(period == "Oct 2020-Sept 2023") %>% 
  mutate(hunter.type = ifelse(respondent.type == "Market", "Vendor", hunter.type))

uses.meat.median <- uses %>% 
  filter(part == "meat") %>% 
  group_by(uses, respondent.type, period, hunter.type) %>% 
  summarise(avg = median(proportion)) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  mutate(hunter.type = ifelse(respondent.type == "Market", "Vendor", hunter.type)) %>% 
  filter (period == "Oct 2020-Sept 2023")

# Use of pangolin scales --------------------------------------------------

uses.scale <- uses %>% 
  filter(part == "scale") %>%
  group_by(uses, period, hunter.type, respondent.type) %>% 
  summarise(avg = mean(proportion)) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  mutate(hunter.type = ifelse(respondent.type == "Market", "Vendor", hunter.type)) %>% 
  filter(period == "Oct 2020-Sept 2023") %>% 
  mutate(uses = factor(uses, levels = c("No access to scales", "Medicine", "Sell", "Discard")))

uses.scale.median <- uses %>% 
  filter(part == "scale") %>%  
  group_by(uses, period, respondent.type, hunter.type) %>% 
  summarise(avg = median(proportion)) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  mutate(hunter.type = ifelse(respondent.type == "Market", "Vendor", hunter.type)) %>% 
  mutate(uses = factor(uses, levels = c("No access to scales", "Medicine", "Sell", "Discard"))) %>% 
  filter (period == "Oct 2020-Sept 2023")



# Reason for hunting pangolins --------------------------------------------

reason.avg <- reason %>% 
  #filter(period == "Oct 2020-Sept 2023") %>% 
  group_by(reason, period, hunter.type) %>% 
  summarise(avg = mean(proportion)) %>% 
  mutate(reason = dplyr::recode(reason, "foodmeat" = "Food (meat)","medicinescale" = "Medicine (scale)", "sellmeat" = "Sell (meat)", "sellscale" = "Sell (scale)"))


reason.avg.median <- reason %>% 
  #filter(period == "Oct 2020-Sept 2023") %>% 
  group_by(reason, period, hunter.type) %>% 
  summarise(avg = median(proportion)) %>% 
  mutate(reason = dplyr::recode(reason, "foodmeat" = "Food (meat)","medicinescale" = "Medicine (scale)", "sellmeat" = "Sell (meat)", "sellscale" = "Sell (scale)")) %>% 
  filter (period == "Oct 2020-Sept 2023")



table(reason$reason)

reason %>% group_by(hunter.type) %>%
  summarize(count_hunters = n_distinct(id))


# Motivation --------------------------------------------------------------

table(motive$motive)

motive.avg <- motive %>% 
  #filter(period == "Oct 2020-Sept 2023") %>% 
  group_by(motive, period, hunter.type) %>% 
  summarise(avg = mean(proportion)) %>% 
  mutate(motive = dplyr::recode(motive, "opportunistic" = "Opportunistic", "paid" = "Paid", "pangolinhunting" = "Pangolin hunting", "wildmeat" = "Wildmeat hunting"))


motive.avg.median <- motive %>% 
  #filter(period == "Oct 2020-Sept 2023") %>% 
  group_by(motive, period, hunter.type) %>% 
  summarise(avg = median(proportion)) %>% 
  mutate(motive = dplyr::recode(motive, "opportunistic" = "Opportunistic", "paid" = "Paid", "pangolinhunting" = "Pangolin hunting", "wildmeat" = "Wildmeat hunting")) %>% 
  filter (period == "Oct 2020-Sept 2023")


# Method ------------------------------------------------------------------

table(method$method)

method.avg <- method %>% 
  #filter(period == "Oct 2020-Sept 2023") %>% 
  group_by(method, period, hunter.type) %>% 
  summarise(avg = mean(proportion)) %>% 
  mutate(method = dplyr::recode(method, "dog" = "Dog", "gun" = "Gun", "pickup" = "Pickup (hand)", "trap" = "Trap"))

method.avg.median <- method %>% 
  #filter(period == "Oct 2020-Sept 2023") %>% 
  group_by(method, period, hunter.type) %>% 
  summarise(avg = median(proportion)) %>% 
  mutate(method = dplyr::recode(method, "dog" = "Dog", "gun" = "Gun", "pickup" = "Pickup (hand)", "trap" = "Trap")) %>% 
  filter (period == "Oct 2020-Sept 2023")


# Number caught -----------------------------------------------------------

number <- number %>% 
  filter(number.caught != 999) %>% 
  filter(number.caught < 200) #Removing any number above 200 as its erroneous. 

length(unique(number$id))

################################################################################
################################################################################
###############                                                #################
###############                    VISUALISE DATA              #################
###############                                                #################
################################################################################
################################################################################

  
# Methods -----------------------------------------------------------------

method.plot <- ggplot(method.avg %>% filter(period == "Oct 2020-Sept 2023" & avg > 0), aes(avg, hunter.type, fill = reorder(method, avg))) + 
  geom_bar(stat = "identity", position = "fill") +
  coord_flip() +
  theme_pubr(base_size = 11.5) +
  labs(y = "Respondent category", x = "Proportion", fill = "Method") +
  theme(axis.title = element_text(size = 14),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 11),
        legend.title = element_text(size = 13),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 11)) +
  scale_fill_manual(values = c("Hand" = "#1a382a", 
                               "Trap" = "#45842e",
                               "Dog" = "#d0e033",
                               "Gun" = "#ee8247")) +
  scale_y_discrete(labels = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor")) 

method.plot


# Context for hunting  -------------------------------------------------

context.plot <- ggplot(motive.avg %>% filter(period == "Oct 2020-Sept 2023" & avg > 0), aes(avg, hunter.type, fill = reorder(motive, avg))) + 
  geom_bar(stat = "identity", position = "fill") +
  coord_flip() +
  theme_pubr(base_size = 11.5) +
  labs(y= "Respondent category", x = "Proportion", fill = "Context") +  
  scale_fill_manual(values = c("Non-paid pangolin hunt"="#ee8247", 
                                "Opportunistic"="#45842e", 
                                "Paid pangolin hunt" ="#d0e033", 
                                "Wild meat hunt"= "#1a382a"))   +
  theme(axis.title = element_text(size = 14),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 11),
        legend.title = element_text(size = 13),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 11)) +
  scale_y_discrete(labels = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor")) 


context.plot
  
# Motivation for hunting ------------------------------------------------------

reason.col <- c("Meat (home use)"="#1a382a", 
                "Meat (sale)"="#45842e",
                "Scale (home use)" ="#d0e033", 
                "Scale (sale)" = "#ee8247")

intention.plot <- ggplot(reason.avg %>% filter(period == "Oct 2020-Sept 2023" & avg > 0), aes(avg, hunter.type, fill = reason)) + 
  geom_bar(stat = "identity", position = "fill") +
  coord_flip() +
  theme_pubr(base_size = 11.5) +
  labs(y= "Respondent category", x = "Proportion", fill = "Intention") +
  scale_fill_manual(values = reason.col,
                   breaks = c("Scale (sale)", "Scale (home use)",  "Meat (sale)", "Meat (home use)" ),
                   labels = c("Scale (sale)", "Scale (home use)",  "Meat (sale)", "Meat (home use)" )
                    ) +
    theme(axis.title = element_text(size = 14),
          strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
          legend.text = element_text(size = 11),
          legend.title = element_text(size = 13),
          legend.position = "right",
          strip.text = element_text(color = "black", size = 11)) +
  scale_y_discrete(labels = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor")) 

intention.plot


fig1 <- ggarrange(method.plot, context.plot, intention.plot,
                  ncol = 1,
                  align = "hv",
                  labels = "AUTO",
                  font.label = list(size = 18))


ggsave("fig1.tiff",
       plot = fig1,
       path = "Figure",
       width = 18,
       height = 23,
       units = c("cm"),
       dpi = 600)


# Uses of pangolin meat ---------------------------------------------------

uses.meat.plot <- ggplot(uses.meat %>% filter(period == "Oct 2020-Sept 2023" & avg > 0), aes(avg, hunter.type, fill = reorder(uses, avg))) +  
  geom_bar(stat = "identity", position = "fill") +
  coord_flip() +
  theme_pubr(base_size = 13) +
  labs(y= "Respondent category", x = "Proportion", fill = "Use of meat") +
  scale_fill_manual(values = c("Eat"="#570934", 
                               "Sell"="#804674",
                               "Medicine" ="#C95501"),
                    breaks = c( "Medicine", "Sell", "Eat"),
                    labels = c("Eat" = "Eat (home use)", "Sell" = "Sell", "Medicine" = "Medicine (home use)")) +
  theme(axis.title = element_text(size = 16),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 13),
        legend.title = element_text(size = 15),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 11)) +
  scale_y_discrete(labels = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor")) 

  

uses.meat.plot

# Uses of pangolin scales ---------------------------------------------------

uses.scale.plot <- ggplot(uses.scale %>% filter(period == "Oct 2020-Sept 2023" & avg > 0), aes(avg, hunter.type, fill = uses)) +  
  geom_bar(stat = "identity", position = "fill") +
  coord_flip() +
  theme_pubr(base_size = 13) +
  labs(y= "Respondent category", x = "Proportion", fill = "Use of scales") +
  scale_fill_manual(values = c("No access to scales"="#113A5D", 
                               "Discard" = "#570934", 
                               "Sell"="#804674",
                               "Medicine" ="#C95501"),
                    breaks = c("Discard", "Sell", "Medicine", "No access to scales"),
                    labels = c("Discard" = "Discard", "Sell" = "Sell", "Medicine" = "Medicine (home use)", "No access to scales" = "Already descaled")) +
  guides(fill = guide_legend(reverse = TRUE)) +
 theme(axis.title = element_text(size = 16),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 13),
        legend.title = element_text(size = 15),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 11)) +
  scale_y_discrete(labels = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor")) 


 
uses.scale.plot


# Save Figure 2 -----------------------------------------------------------


fig2 <- ggarrange(uses.scale.plot, uses.meat.plot,
                  ncol = 1,
                  labels = "AUTO",
                  align ="hv",
                  font.label = list(size = 20))


ggsave("fig2.tiff",
       plot = fig2,
       path = "Figure",
       width = 21,
       height = 20,
       units = c("cm"),
       dpi = 600)


# Number caught -----------------------------------------------------------

ggplot(number, aes(species, number.caught, colour = season)) + 
  geom_boxplot() +
  scale_color_aaas() +
  theme_pubr(base_size = 20) +
  labs(x= "Species", y = "Number caught/hunter/season in l3y", col = "") 


species.compare <- number %>% 
  group_by(hunter.type, species, season) %>% 
  summarise(avg = median(number.caught)) %>% 
  group_by(hunter.type, species) %>% 
  summarise(avg.season = sum(avg))

trapper.percent <- species.compare %>% 
  group_by(species) %>% 
  summarise(percent = avg.season[hunter.type == "Trapper"]/sum(avg.season)*100)

ggplot(trapper.percent, aes(percent)) +
  geom_density()

median(trapper.percent$percent)


################################################################################
################################################################################
###############                                                #################
###############             SUPPLEMENTARY FIGURES              #################
###############                                                #################
################################################################################
################################################################################


# Methods -----------------------------------------------------------------

method.avg.supp <- method.avg %>% 
  mutate(method = factor(method, levels = c("Gun", "Dog", "Trap","Hand")))

method.plot.supp <- ggplot(method.avg.supp %>% filter(period != "Oct 2020-Sept 2023"), aes(avg, period, fill = method)) + 
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~hunter.type, scales = "free_x", labeller = labeller(hunter.type = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter"))) +
  coord_flip() +
  theme_pubr(base_size = 12) +
  labs(y = "Period", x = "Proportion", fill = "Method") +
  theme(axis.title = element_text(size = 18),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 17),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 15)) +
  scale_fill_manual(values = c("Hand" = "#1a382a", 
                               "Trap" = "#45842e",
                               "Dog" = "#d0e033",
                               "Gun" = "#ee8247")) +
  scale_y_discrete(labels = c("Jan 2010-Dec 2015" = " 2010-\n2015",
                              "Jan 2016-Feb 2020" = " 2016-\n2020",
                              "April-Sept 2020 (COVID lockdown)" = "COVID-19\nlockdown", 
                              "Oct 2020-Sept 2023" = "Post-\nlockdown")) 

method.plot.supp


# Context for hunting  -------------------------------------------------

context.plot.supp <- ggplot(motive.avg %>% filter(period != "Oct 2020-Sept 2023"), aes(avg, period, fill = reorder(motive, avg))) + 
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~hunter.type, scales = "free_x", labeller = labeller(hunter.type = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter"))) +
  coord_flip() +
  theme_pubr(base_size = 12) +
  labs(y= "Period", x = "Proportion", fill = "Context") +  
  scale_fill_manual(values = c("Non-paid pangolin hunt"="#ee8247", 
                               "Opportunistic"="#45842e", 
                               "Paid pangolin hunt" ="#d0e033", 
                               "Wild meat hunt"= "#1a382a")) +
  theme(axis.title = element_text(size = 18),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 17),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 15)) +
  scale_y_discrete(labels = c("Jan 2010-Dec 2015" = " 2010-\n2015",
                              "Jan 2016-Feb 2020" = " 2016-\n2020",
                              "April-Sept 2020 (COVID lockdown)" = "COVID-19\nlockdown", 
                              "Oct 2020-Sept 2023" = "Post-\nlockdown")) +
  guides(fill = guide_legend(nrow = 4))


context.plot.supp

# Motivation for hunting ------------------------------------------------------

intention.plot.supp <- ggplot(reason.avg %>% filter(period != "Oct 2020-Sept 2023"), aes(avg, period, fill = reason)) +   
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~hunter.type, scales = "free_x", labeller = labeller(hunter.type = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter"))) +
  coord_flip() +
  theme_pubr(base_size = 12) +
  labs(y= "Period", x = "Proportion", fill = "Intention") +
  scale_fill_manual(values = reason.col) +
  theme(axis.title = element_text(size = 18),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 17),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 15)) +
  scale_y_discrete(labels = c("Jan 2010-Dec 2015" = " 2010-\n2015",
                              "Jan 2016-Feb 2020" = " 2016-\n2020",
                              "April-Sept 2020 (COVID lockdown)" = "COVID-19\nlockdown", 
                              "Oct 2020-Sept 2023" = "Post-\nlockdown")) +
  guides(fill = guide_legend(nrow = 4))


intention.plot.supp


fig1.supp <- ggarrange(method.plot.supp, context.plot.supp, intention.plot.supp,
                       ncol = 1,
                       align = "hv",
                       labels = "AUTO",
                       font.label = list(size = 20))


ggsave("figS2.tiff",
       plot = fig1.supp,
       path = "Figure",
       width = 20,
       height = 25,
       units = c("cm"),
       dpi = 600)


# Uses of pangolin meat ---------------------------------------------------

uses.meat.supp <- uses %>% 
  filter(part == "meat") %>% 
  group_by(uses, period, hunter.type, respondent.type) %>% 
  summarise(avg = mean(proportion)) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  mutate(hunter.type = ifelse(respondent.type == "Market", "Vendor", hunter.type))


uses.meat.plot.supp <- ggplot(uses.meat.supp  %>% filter(period != "Oct 2020-Sept 2023"), aes(avg, period, fill = reorder(uses, avg))) +  
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~hunter.type, scales = "free_x", labeller = labeller(hunter.type = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor"))) +
  coord_flip() +
  theme_pubr(base_size = 15) +
  labs(y= "Period", x = "Proportion", fill = "Uses of meat") +
  scale_fill_manual(values = c("Eat"="#570934", 
                               "Sell"="#804674",
                               "Medicine" ="#C95501"),
                    breaks = c( "Medicine", "Sell",  "Eat"),
                    labels = c("Eat" = "Eat (home use)", "Sell" = "Sell", "Medicine" = "Medicine (home use)")) +
  theme(axis.title = element_text(size = 13),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.title = element_text(size = 15),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 13)) +
  scale_y_discrete(labels = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor")) +
  scale_y_discrete(labels = c("Jan 2010-Dec 2015" = " 2010-\n2015",
                              "Jan 2016-Feb 2020" = " 2016-\n2020",
                              "April-Sept 2020 (COVID lockdown)" = "COVID-19\nlockdown", 
                              "Oct 2020-Sept 2023" = "Post-\nlockdown"))


uses.meat.plot.supp

# Uses of pangolin scales ---------------------------------------------------

uses.scale.supp <- uses %>% 
  filter(part == "scale") %>%
  group_by(uses, period, hunter.type, respondent.type) %>% 
  summarise(avg = mean(proportion)) %>% 
  mutate(period = factor(period, levels = c("Jan 2010-Dec 2015", "Jan 2016-Feb 2020", "April-Sept 2020 (COVID lockdown)", "Oct 2020-Sept 2023"))) %>% 
  mutate(hunter.type = ifelse(respondent.type == "Market", "Vendor", hunter.type)) %>% 
  mutate(uses = factor(uses, levels = c("No access to scales", "Medicine", "Sell", "Discard")))

uses.scale.plot.supp <- ggplot(uses.scale.supp  %>% filter(period != "Oct 2020-Sept 2023"), aes(avg, period, fill = uses)) +  
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~hunter.type, scales = "free_x", labeller = labeller(hunter.type = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor"))) +
  coord_flip() +
  theme_pubr(base_size = 15) +
  labs(y= "Period", x = "Proportion", fill = "Uses of scales") +
  scale_fill_manual(values = c("No access to scales"="#113A5D", 
                               "Discard" = "#570934", 
                               "Sell"="#804674",
                               "Medicine" ="#C95501"),
                    breaks = c("Discard", "Sell", "Medicine", "No access to scales"),
                    labels = c("Discard" = "Discard", "Sell" = "Sell", "Medicine" = "Medicine (home use)", "No access to scales" = "Already descaled")) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(axis.title = element_text(size = 13),
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        legend.position = "right",
        strip.text = element_text(color = "black", size = 15)) +
  scale_y_discrete(labels = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter", "Vendor" = "Vendor")) +
  scale_y_discrete(labels = c("Jan 2010-Dec 2015" = " 2010-\n2015",
                              "Jan 2016-Feb 2020" = " 2016-\n2020",
                              "April-Sept 2020 (COVID lockdown)" = "COVID-19\nlockdown", 
                              "Oct 2020-Sept 2023" = "Post-\nlockdown"))


uses.scale.plot.supp


# Save Figure 2 -----------------------------------------------------------


fig2.supp <- ggarrange(uses.scale.plot.supp, uses.meat.plot.supp,
                       ncol = 1,
                       labels = "AUTO",
                       align ="hv",
                       font.label = list(size = 18))



ggsave("figS3.tiff",
       plot = fig2.supp,
       path = "Figure",
       width = 23,
       height = 13,
       units = c("cm"),
       dpi = 600)



################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
###############                                                #################
###############                  MASS DATA                     #################
###############                                                #################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#NOTE: The following data sets contain information on the mass of wild meat carcasses sold 
#in markets in SE Nigeria, which, in the paper, we used to estimate the total mass 
#of pangolins harvested, given the number reportedly hunted. See manuscript for details.


# MEAT --------------------------------------------------------------------

mass.gen <- read.csv("05.mass.gen.csv")
mass.piece <- read.csv("06.mass.piece.csv")


mass.piece$gen.piece = rep(NA, nrow(mass.piece))
lst = list()

for (i in unique(mass.piece$X_parent_index)) {
  vec = 1:nrow(subset(mass.piece, mass.piece$X_parent_index == i))
  lst[[i]] = vec
}

mass.piece$gen.piece = unlist(lst)
mass.piece$piece.id = paste0(mass.piece$X_submission__id, "_", mass.piece$gen.piece)

mass = merge(mass.gen, mass.piece, by.x = "X_id", by.y = "X_submission__id", all = TRUE)

mass <- mass %>% 
  dplyr::select(- c(X_index.y:X_submission__tags, X_uuid:X_index.x, Surveyor, Village)) %>% 
  dplyr::rename(species = What.type.of.meat.is.on.sale.,
         respondent.type = What.category.of.respondent.are.you.interviewing.,
         number.sold = How.many.pieces.of.the.meat.is.on.sale.,
         part = Part.of.animal,
         state = What.is.the.state.of.the.animal.part.,
         price = What.is.the.price.of.animal.piece..NGN.,
         mass = What.is.the.weight.of.the.animal.piece.)


pang.mass <- mass %>% 
  filter(species %in% c("White-bellied pangolin", "Black-bellied pangolin")) %>% 
  filter(part =="Whole animal",
         state == "Dry (Smoked)")%>% 
  group_by(species) %>% 
  summarise(median.mass.part = median (mass)) %>% 
  mutate(part = "Meat")


# SCALE -------------------------------------------------------------------

scale <- read.csv("07.scale.mass.csv")

names(scale)

scale <- scale %>% 
  dplyr::rename(species = Species.ID,
         sex = Sex.of.animal,
         age = Age.of.animal..g.,
         mass.fresh = mass.of.fresh.pangolin..g.,
         mass.scale.whole = mass.of.whole.pangolin.scales..g.,) %>% 
  dplyr::select(species:mass.scale.whole) %>% 
  drop_na() %>% 
  group_by(species) %>%
  summarise(median.mass.part = median(mass.scale.whole)/1000) %>% 
  mutate(part = "Scale")



################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
###############                                                #################
###############             SPECIES EXTRACTION RATE            #################
###############                                                #################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################


# Extract and display pangolin data ---------------------------------------

number.pang <- number %>% 
  filter(species == c("bbp", "wbp")) %>% 
  mutate(species = dplyr::recode(species, "wbp" = "White-bellied pangolin",
                          "bbp" = "Black-bellied pangolin"),
         season = dplyr::recode(season, "wet" = "Wet",
                         "dry" = "Dry"))

number.pang1 <- number %>% 
  mutate(species = dplyr::recode(species, "wbp" = "White-bellied pangolin",
                          "bbp" = "Black-bellied pangolin", 
                          "porcupine" = "African brush-tailed porcupine",
                          "duiker" = "Blue duiker",
                          "rrh" = "Red river hog"),
         season = dplyr::recode(season, "wet" = "Wet",
                         "dry" = "Dry"))

ggplot(number.pang, aes(species, number.caught, colour = season)) + 
  geom_boxplot() +
  scale_color_aaas() +
  theme_pubr(base_size = 20) +
  labs(x= "Species", y = "Number caught/hunter/season in l3y", col = "") 

# Visualize distribution  -------------------------------------------------

ggplot(number.pang, aes(number.caught)) +
  geom_density() +
  facet_wrap(~species)


################################################################################
################################################################################
###############                                                #################
###############                BOOTSTRAP RATES                 #################
###############                                                #################
################################################################################
################################################################################

# Calculate number of hunters per and across communities ------------------

#GUN HUNTER =============
hunter.count <- comm.clean %>% 
  group_by(location) %>% 
  summarise(count.hunter = sum(gun.hunter.count)) %>% 
  mutate(hunter.type = "Gun")

hunter.count.avg <- hunter.count %>% 
  summarise(median.hunter = median(count.hunter)) %>% 
  mutate(hunter.type = "Gun") %>% 
  dplyr::select(hunter.type, median.hunter)

# TRAPPER ==============
trapper.count <- comm.clean %>% 
  group_by(location) %>% 
  summarise(count.hunter = sum(trapper.count)) %>% 
  mutate(hunter.type = "Trapper")

trapper.count.avg <- trapper.count %>% 
  summarise(median.hunter = median(count.hunter)) %>% 
  mutate(hunter.type = "Trapper") %>% 
  dplyr::select(hunter.type, median.hunter)



################################################
################################################

# Calculate total number of pangolins killed per species and per hunter type in the sample communities
boots.pang <- number.pang %>% 
  group_by(id, species, hunter.type, location) %>% 
  summarise(total.caught = sum(number.caught)) 

library(boot)

################################################################################
################################################################################
########################   BLACK-BELLIED PANGOLIN  #############################
################################################################################
################################################################################


# FORMAL HUNTER -----------------------------------------------------------

bbp.formal <- boots.pang %>% 
  filter(species == "Black-bellied pangolin" & hunter.type == "Gun")


# Create simple function to get the average d to take a whatever data

median.function <- function(x, index) {
  d <- x[index]     # This first line will go in all bootstrap function.
  return(mean(d))  #Here I am using mean as median, which is more appropriate, does not compute for red river hog. 
}

# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.bbp.formal <- boot(data = bbp.formal$total.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.bbp.formal.plot <- data.frame(xbar=boot.bbp.formal$t)
ggplot(boot.bbp.formal.plot, aes(x=xbar)) +
  geom_histogram() 


# Calculate the 95% confidence interval using the `car` package which also makes more robust intervals.
# By default it uses the 'bca' method which is generally more robust
confint(boot.bbp.formal, level=.95, type='perc') 

boot.bbp.formal.df <- as.data.frame(confint(boot.bbp.formal, level=.95, type='perc'))

boot.bbp.formal.df <- boot.bbp.formal.df %>% 
  mutate(hunter.type = "Gun", species = "Black-bellied pangolin")


# CASUAL HUNTER -----------------------------------------------------------

bbp.trapper <- boots.pang %>% 
  filter(species == "Black-bellied pangolin" & hunter.type == "Trapper")


# Create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.bbp.trapper <- boot(data = bbp.trapper$total.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.bbp.trapper.plot <- data.frame(xbar=boot.bbp.trapper$t)
ggplot(boot.bbp.trapper.plot, aes(x=xbar)) +
  geom_histogram() 

# 95% confidence interval 
boot.bbp.trapper.df <- as.data.frame(confint(boot.bbp.trapper, level=.95, type='perc'))

boot.bbp.trapper.df <- boot.bbp.trapper.df %>% 
  mutate(hunter.type = "Trapper", species = "Black-bellied pangolin")


################################################################################
################################################################################
########################   WHITE-BELLIED PANGOLIN  #############################
################################################################################
################################################################################

# CASUAL HUNTER -----------------------------------------------------------

wbp.trapper <- boots.pang %>% 
  filter(species == "White-bellied pangolin" & hunter.type == "Trapper")

# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.wbp.trapper <- boot(data = wbp.trapper$total.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.wbp.trapper.plot <- data.frame(xbar=boot.wbp.trapper$t)
ggplot(boot.wbp.trapper.plot, aes(x=xbar)) +
  geom_histogram() 

# 95% confidence interval 
boot.wbp.trapper.df <- as.data.frame(confint(boot.wbp.trapper, level=.95, type='perc'))

boot.wbp.trapper.df <- boot.wbp.trapper.df %>% 
  mutate(hunter.type = "Trapper", species = "White-bellied pangolin")


# FORMAL HUNTER -----------------------------------------------------------

wbp.formal <- boots.pang %>% 
  filter(species == "White-bellied pangolin" & hunter.type == "Gun")

# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.wbp.formal <- boot(data = wbp.formal$total.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.wbp.formal.plot <- data.frame(xbar=boot.wbp.formal$t)
ggplot(boot.wbp.formal.plot, aes(x=xbar)) +
  geom_histogram() 


# 95% confidence interval 
boot.wbp.formal.df <- as.data.frame(confint(boot.wbp.formal, level=.95, type='perc'))

boot.wbp.formal.df <- boot.wbp.formal.df %>% 
  mutate(hunter.type = "Gun", species = "White-bellied pangolin")


################################################################################
################################################################################
########################         PORCUPINE         #############################
################################################################################
################################################################################

# CASUAL HUNTER -----------------------------------------------------------

porc.trapper <- number %>% 
  filter(species == "porcupine" & hunter.type == "Trapper")

# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.porc.trapper <- boot(data = porc.trapper$number.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.porc.trapper.plot <- data.frame(xbar=boot.porc.trapper$t)
ggplot(boot.porc.trapper.plot, aes(x=xbar)) +
  geom_histogram() 


# 95% confidence interval
boot.porc.trapper.df <- as.data.frame(confint(boot.porc.trapper, level=.95, type='perc'))


boot.porc.trapper.df <- boot.porc.trapper.df %>% 
  mutate(hunter.type = "Trapper", species = "African brush-tailed porcupine")


# FORMAL HUNTER -----------------------------------------------------------

porc.formal <- number %>% 
  filter(species == "porcupine" & hunter.type == "Gun")

# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.porc.formal <- boot(data = porc.formal$number.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.porc.formal.plot <- data.frame(xbar=boot.porc.formal$t)
ggplot(boot.porc.formal.plot, aes(x=xbar)) +
  geom_histogram() 


# 95% confidence interval 
boot.porc.formal.df <- as.data.frame(confint(boot.porc.formal, level=.95, type='perc'))

boot.porc.formal.df <- boot.porc.formal.df %>% 
  mutate(hunter.type = "Gun", species = "African brush-tailed porcupine")


################################################################################
################################################################################
########################         PORCUPINE         #############################
################################################################################
################################################################################

# CASUAL HUNTER -----------------------------------------------------------

duiker.trapper <- number %>% 
  filter(species == "duiker" & hunter.type == "Trapper")


# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.duiker.trapper <- boot(data = duiker.trapper$number.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.duiker.trapper.plot <- data.frame(xbar=boot.duiker.trapper$t)
ggplot(boot.duiker.trapper.plot, aes(x=xbar)) +
  geom_histogram() 

# 95% confidence interval 
boot.duiker.trapper.df <- as.data.frame(confint(boot.duiker.trapper, level=.95, type='perc'))


boot.duiker.trapper.df <- boot.duiker.trapper.df %>% 
  mutate(hunter.type = "Trapper", species = "Blue duiker")


# FORMAL HUNTER -----------------------------------------------------------

duiker.formal <- number %>% 
  filter(species == "duiker" & hunter.type == "Gun")

# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.duiker.formal <- boot(data = duiker.formal$number.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.duiker.formal.plot <- data.frame(xbar=boot.duiker.formal$t)
ggplot(boot.duiker.formal.plot, aes(x=xbar)) +
  geom_histogram() 

# 95% confidence interval 
boot.duiker.formal.df <- as.data.frame(confint(boot.duiker.formal, level=.95, type='perc'))


boot.duiker.formal.df <- boot.duiker.formal.df %>% 
  mutate(hunter.type = "Gun", species = "Blue duiker")


################################################################################
################################################################################
####################           RED RIVER HOG            ########################
################################################################################
################################################################################

# CASUAL HUNTER -----------------------------------------------------------

rrh.trapper <- number %>% 
  filter(species == "rrh" & hunter.type == "Trapper")


# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.rrh.trapper <- boot(data = rrh.trapper$number.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.rrh.trapper.plot <- data.frame(xbar=boot.rrh.trapper$t)
ggplot(boot.rrh.trapper.plot, aes(x=xbar)) +
  geom_histogram() 

# 95% confidence interval 
boot.rrh.trapper.df <- as.data.frame(confint(boot.rrh.trapper, level=.95, type='perc'))

boot.rrh.trapper.df <- boot.rrh.trapper.df %>% 
  mutate(hunter.type = "Trapper", species = "Red river hog")


# FORMAL HUNTER -----------------------------------------------------------

rrh.formal <- number %>% 
  filter(species == "rrh" & hunter.type == "Gun")

# create the Estimated Sampling Distribution of xbar
set.seed(32)
boot.rrh.formal <- boot(data = rrh.formal$number.caught, statistic = median.function, R=10000)

# show a histogram of the estimated sampling distribution of xbar
boot.rrh.formal.plot <- data.frame(xbar=boot.rrh.formal$t)
ggplot(boot.rrh.formal.plot, aes(x=xbar)) +
  geom_histogram() 

# 95% confidence interval 
boot.rrh.formal.df <- as.data.frame(confint(boot.rrh.formal, level=.95, type='perc'))


boot.rrh.formal.df <- boot.rrh.formal.df %>% 
  mutate(hunter.type = "Gun", species = "Red river hog")


################################################################################
################################################################################
#########################           MERGE DATA           #######################
################################################################################
################################################################################

# Calculate average number of pangolins killed per hunter per day for each hunter type
avg.killed1 <- boots.pang %>%
  group_by(species, hunter.type) %>%
  summarise(avg.killed = mean(total.caught))


# Calculate average number of pangolins killed per hunter per day for each hunter type
avg.killed2 <- number %>%
  group_by(species, hunter.type) %>%
  summarise(avg.killed = mean(number.caught)) %>% 
  filter(species == "rrh" | species == "duiker" | species == "porcupine") %>% 
  mutate(species = dplyr::recode(species, "rrh" = "Red river hog", "duiker" = "Blue duiker", "porcupine" = "African brush-tailed porcupine"))

#Merge species averages
avg.killed <- avg.killed1 %>% 
  bind_rows(avg.killed2)


# Estimate total number of hunters per hunter type across the landscape

hunter.type <- hunter.count %>% 
  bind_rows(trapper.count) %>% 
  group_by(hunter.type) %>% 
  summarise(avg.number = median(count.hunter)) %>% 
  mutate(total.hunter = avg.number * 144) 

total.landscape <- hunter.type %>% 
  left_join(avg.killed, by = "hunter.type") %>%
  mutate(total.killed = avg.killed * total.hunter)


species.hunter.avgs <- boot.bbp.formal.df %>% 
  bind_rows(boot.bbp.trapper.df, boot.wbp.formal.df, boot.wbp.trapper.df,
            boot.porc.formal.df, boot.porc.trapper.df, 
            boot.duiker.formal.df, boot.duiker.trapper.df,
            boot.rrh.formal.df, boot.rrh.trapper.df) %>% 
  mutate(low.ci = `2.5 %`, 
         high.ci = `97.5 %`) %>% 
  subset(select = hunter.type:high.ci)

avg.killed.median <- avg.killed %>% 
  left_join(species.hunter.avgs, by = c("species", "hunter.type")) %>% 
  left_join(hunter.type, by = "hunter.type") %>% 
  mutate(total.est = avg.killed*total.hunter,
         total.est.low = low.ci*total.hunter,
         total.est.high = high.ci*total.hunter) %>% 
  ungroup()


avg.killed.median %>% group_by(species, hunter.type) %>% reframe(sum = total.est)
avg.killed.median %>% group_by(species, hunter.type) %>% reframe(sum = total.est.high)
avg.killed.median %>% group_by(species, hunter.type) %>% reframe(sum = total.est.low) 


sum(avg.killed.median$total.hunter)


avg.killed.median1 <- avg.killed.median %>% 
  mutate(species = factor(species, levels = c("Black-bellied pangolin",
                                              "White-bellied pangolin",
                                              "African brush-tailed porcupine",
                                              "Blue duiker",
                                              "Red river hog"))) %>% 
  mutate(hunter.type = factor(hunter.type, levels = c("Gun", "Trapper"))) 


################################################################################
################################################################################
###########    VISUALISE NUMBER OF ANIMALS CAUGHT ACROSS SPECIES   #############
################################################################################
################################################################################

extrapolated.count <- ggplot(avg.killed.median1, aes(hunter.type, total.est, fill = species)) +
  geom_bar(position="dodge", stat = "identity", width =.80) +
  geom_errorbar(data = avg.killed.median1, aes(y = total.est, x = hunter.type, ymin = total.est.low, ymax = total.est.high), 
                width =.15, size = 1, position=position_dodge(width = 0.80)) +
  theme_pubr(base_size = 17) +
  theme(axis.title = element_text(size = 20),
        strip.text = element_text(size = 15),
        legend.text = element_text(size = 17),
        legend.position = "top",
        strip.background = element_rect(fill = "white", color = "black", linetype = "solid")) +
  labs(y = "Number caught/year", x = "Hunter category", fill = "") +
  scale_x_discrete(labels = c("Gun" = "Formal", "Trapper" = "Casual")) +
  scale_fill_npg() +
  scale_y_continuous(breaks = seq(0,50000,10000), labels = scales::comma) +
  guides(fill = guide_legend(nrow = 2))


extrapolated.count

ggsave("figS1.tiff",
       plot = extrapolated.count,
       path = "Figure",
       width = 25,
       height = 17,
       units = c("cm"),
       dpi = 600)


################################################################################
################################################################################
################################################################################
###############                                                #################
###############            RECALL VS MONITORING                #################
###############                                                #################
################################################################################
################################################################################
################################################################################

#NOTE: This section compares the data collected for this study with data from the same landscape 
#recorded directly from hunters on a per trip basis. Details are in the manuscript.

# COMPARE OFFTAKE OF GUN HUNTERS ------------------------------------------

offtake.study <- read.csv("08.count.pang.csv")

# Number the number killed per species per hunter (data from current study)
number.compare <- number %>% 
  mutate(species = dplyr::recode(species, "rrh" ="Red river hog", "bbp" = "Black-bellied pangolin","duiker" = "Blue duiker", 
                          "porcupine" = "African brush-tailed porcupine", "wbp" = "White-bellied pangolin"),
         season = dplyr::recode(season, "dry" = "Dry", "wet" ="Wet")) %>% 
  group_by(species, id, season, hunter.type) %>% 
  summarise(number.caught = sum(number.caught)) %>% 
  subset(select = -c(id)) %>% 
  mutate(study = "Current Study") %>% 
  filter(number.caught != 0)


#Plot data
ggplot(number.compare, aes(season, number.caught)) +
  geom_boxplot() +
  facet_wrap(~species) +
  theme_bw()


offtake.study <- offtake.study %>% 
  group_by(hunter.id,village, species, season) %>% 
  summarise(number.caught = sum(number.caught)) %>% 
  mutate(hunter.type = "Gun") %>% 
  ungroup() %>% 
  group_by(village, hunter.id) %>% 
  subset(select = c(species:hunter.type)) %>% 
  mutate(study = "Past study")

compare.pang <-offtake.study %>% 
  bind_rows(number.compare) %>% 
  mutate(study = dplyr::recode(study, "Past study" = "Direct monitoring (past study)",
                        "Current Study" = "Recall (current study)"),
         study = factor(study, levels = c ("Recall (current study)", "Direct monitoring (past study)")),
         species = factor(species, levels = c("Black-bellied pangolin", "White-bellied pangolin", "African brush-tailed porcupine",
                                              "Blue duiker", "Red river hog")))


col.fig <- c("Direct monitoring (past study)" = "#45842e", "Recall (current study)" =  "#804674")


compare.fig <- ggplot(compare.pang, aes(x = factor(season), y = number.caught, col = study)) + 
  geom_boxplot( outlier.size = 2, outlier.alpha = .5) +
  facet_grid(hunter.type ~ species, scales = "free_x", labeller = labeller(hunter.type = c("Gun" = "Formal hunter", "Trapper" = "Casual hunter"), 
                                                                           species = c("White-bellied pangolin" = "White-bellied pangolin", 
                                                                                       "Black-bellied pangolin" = "Black-bellied pangolin",
                                                                                       "African brush-tailed porcupine" = "African brush-tailed\n porcupine",
                                                                                       "Blue duiker" = "Blue duiker",
                                                                                       "Red river hog" = "Red river hog"))) +
  theme_pubr(base_size = 16.5) +
  labs(x= "Season", y = "Number caught per hunter", col = "") +
  theme(strip.background = element_rect(fill = "white", color = "black", linetype = "solid"),
        legend.text = element_text(size = 16),
        axis.title = element_text(size = 18),
        strip.text = element_text(color = "black", size = 14)) +
  scale_colour_manual(values = col.fig)

compare.fig


ggsave("figS4.tiff",
       plot = compare.fig,
       path = "Figure",
       width = 32,
       height = 17,
       units = c("cm"),
       dpi = 600)


################################################################################
################################################################################
###############                                                #################
###############             ADDITIONAL CALCULATIONS            #################
###############                                                #################
################################################################################
################################################################################

#NOTE: contains estimates of pangolin mass from the number of individuals reportedly killed. 


# Compare offtake between gun hunters and trappers ------------------------

pang.hunter.type <- number.pang %>% 
  group_by(species, hunter.type) %>% 
  summarise(number.caught = median(number.caught))


# Calculate number of hunters per and across communities ------------------

#GUN HUNTER =============
hunter.count <- comm.clean %>% 
  group_by(location) %>% 
  summarise(count.hunter = sum(gun.hunter.count)) %>% 
  mutate(hunter.tye = "Gun")

hunter.count.avg <- hunter.count %>% 
  summarise(median.hunter = median(count.hunter)) %>% 
  mutate(hunter.type = "Gun") %>% 
  dplyr::select(hunter.type, median.hunter)

# TRAPPER ==============
trapper.count <- comm.clean %>% 
  group_by(location) %>% 
  summarise(count.hunter = sum(trapper.count)) %>% 
  mutate(hunter.tye = "Trapper")

trapper.count.avg <- trapper.count %>% 
  summarise(median.hunter = median(count.hunter)) %>% 
  mutate(hunter.type = "Trapper") %>% 
  dplyr::select(hunter.type, median.hunter)


hunter.type <- hunter.count %>% 
  bind_rows(trapper.count)

# VENDOR ==============
vendor.count <- comm.clean %>% 
  group_by(location) %>% 
  summarise(count.vendor = sum(trader.count))

vendor.count.avg <- vendor.count %>% 
  summarise(median.vendor = median(count.vendor)) 


#MERGE AVERAGES WITH NUMBER CAUGHT ======
pang.species <- data.frame(species = c("Black-bellied pangolin", "White-bellied pangolin"))

context.avg.extra <- motive %>% 
  group_by(motive) %>% 
  summarise(proportion = median(proportion)) %>% 
  filter(proportion != 0) %>% 
  cross_join(pang.species) 

use.hunter.avg.extra <- uses %>% 
  filter(respondent.type == "Hunter") %>% 
  group_by(uses, part) %>% 
  summarise(proportion = median(proportion)) %>% 
  filter(proportion != 0) %>% 
  cross_join(pang.species) %>% 
  ungroup() %>% 
  mutate(part = dplyr::recode(part, "meat" = "Meat", "scale" = "Scale"))


intention.avg.extra <- motive %>% 
  group_by(motive) %>% 
  summarise(proportion = median(proportion))


method.avg.extra <- method %>% 
  group_by(method, hunter.type) %>% 
  summarise(proportion = median(proportion)) %>% 
  filter(proportion != 0) %>% 
  cross_join(pang.species) 


meat.exprapolation <- avg.killed.median %>% 
  left_join(pang.mass, by = "species") %>% 
  filter(species == "White-bellied pangolin" | species == "Black-bellied pangolin") %>% 
  mutate(total.mass = median.mass.part * total.est) 



scale.extrapolation <-avg.killed.median %>% 
  left_join(scale, by = "species") %>% 
  filter(species == "White-bellied pangolin" | species == "Black-bellied pangolin") %>% 
  mutate(total.mass = median.mass.part * total.est) 


# Across species

landscape.captures.across <- scale.extrapolation %>% 
  bind_rows(meat.exprapolation) 

sum(landscape.captures.across$total.mass)

landscape.captures.across %>% 
  group_by(hunter.type) %>% 
  summarise(sum = sum(total.mass))

landscape.captures.across %>% 
  group_by(part) %>% 
  summarise(sum = sum(total.mass))




